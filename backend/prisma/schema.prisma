// Prisma Schema for VocaVision

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String?   @unique
  password      String?
  name          String?
  avatar        String?
  role          UserRole  @default(USER)

  // OAuth
  kakaoId       String?   @unique
  googleId      String?   @unique
  provider      String    @default("local") // local, kakao, google

  // Subscription
  subscriptionStatus SubscriptionStatus @default(FREE)
  subscriptionId     String?
  subscriptionPlan   SubscriptionPlan?
  subscriptionStart  DateTime?
  subscriptionEnd    DateTime?
  trialEnd          DateTime?

  // Billing (ì •ê¸°ê²°ì œ)
  billingKey        String?   // TossPayments ë¹Œë§í‚¤
  customerKey       String?   // TossPayments ê³ ê° ì‹ë³„í‚¤
  autoRenewal       Boolean   @default(true)  // ìë™ ê°±ì‹  ì—¬ë¶€
  lastPaymentId     String?   // ë§ˆì§€ë§‰ ê²°ì œ ID

  // Learning Stats
  totalWordsLearned Int @default(0)
  currentStreak     Int @default(0)
  longestStreak     Int @default(0)
  lastActiveDate    DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Daily Goals
  dailyGoal     Int       @default(20) // Daily word goal
  dailyProgress Int       @default(0)  // Words studied today
  lastGoalReset DateTime?

  // Relations
  progress      UserProgress[]
  reviews       Review[]
  customMnemonics CustomMnemonic[]
  studySessions StudySession[]
  achievements  UserAchievement[]
  bookmarks     Bookmark[]
  notifications Notification[]
  decks         Deck[]
  leagueMemberships LeagueMembership[]
  purchases     UserPurchase[]

  // Notification Preferences
  emailNotifications    Boolean @default(true)
  pushNotifications     Boolean @default(true)
  reminderTime          String  @default("09:00") // HH:mm format
  reminderDays          String  @default("1,2,3,4,5,6,7") // Days of week (1=Mon, 7=Sun)

  @@index([email])
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum SubscriptionStatus {
  FREE
  TRIAL
  ACTIVE
  CANCELLED
  EXPIRED
}

enum SubscriptionPlan {
  MONTHLY
  YEARLY
  FAMILY
}

// ============================================
// Vocabulary
// ============================================

model Word {
  id          String   @id @default(uuid())
  word        String
  wordType    WordType @default(WORD)  // ë‹¨ì–´/êµ¬ë¬¸ íƒ€ì…
  definition  String
  definitionKo String?  // í•œêµ­ì–´ ëœ»
  pronunciation String?
  phonetic    String?
  partOfSpeech PartOfSpeech
  difficulty  DifficultyLevel @default(INTERMEDIATE)
  cefrLevel   CEFRLevel?      // CEFR ë ˆë²¨ (A1-C2)
  examCategory ExamCategory   // ê¸°ë³¸ ì‹œí—˜ ì¹´í…Œê³ ë¦¬ (í•˜ìœ„ í˜¸í™˜ìš©)
  level       String?         // ê¸°ë³¸ ë ˆë²¨ (L1, L2, L3 ë“±)
  frequency   Int      @default(0) // Word frequency ranking
  tags        String[] // ì˜ë¯¸/ì£¼ì œ íƒœê·¸ (ì¼ë°˜, ê³¼í•™, ì‹¬ë¦¬ ë“±)

  // Additional learning content
  tips        String?  // í•™ìŠµ íŒ
  commonMistakes String? // í”í•œ ì‹¤ìˆ˜

  // ===== ë°œìŒ (Pronunciation) - í™•ì¥ =====
  ipaUs       String?  // /ËˆÃ¦p.É™l/ ë¯¸êµ­ì‹ IPA
  ipaUk       String?  // ì˜êµ­ì‹ IPA
  audioUrlUs  String?  // ë¯¸êµ­ì‹ ë°œìŒ ì˜¤ë””ì˜¤ URL
  audioUrlUk  String?  // ì˜êµ­ì‹ ë°œìŒ ì˜¤ë””ì˜¤ URL

  // ===== í˜•íƒœ ë¶„ì„ (Morphology) =====
  prefix      String?  // ì ‘ë‘ì‚¬ "un-", "re-"
  root        String?  // ì–´ê·¼ "port" (ë‚˜ë¥´ë‹¤)
  suffix      String?  // ì ‘ë¯¸ì‚¬ "-tion", "-ly"
  morphologyNote String? // í˜•íƒœ ë¶„ì„ ì„¤ëª…

  // ===== ê´€ë ¨ì–´ ë°°ì—´ (ë¹ ë¥¸ ì¡°íšŒìš©) =====
  synonymList    String[] // ë™ì˜ì–´ ë°°ì—´
  antonymList    String[] // ë°˜ì˜ì–´ ë°°ì—´
  rhymingWords   String[] // ë¼ì´ë° ë‹¨ì–´ ë°°ì—´
  relatedWords   String[] // ê´€ë ¨ì–´ ë°°ì—´

  // ===== ì½˜í…ì¸  ìƒíƒœ (Admin) =====
  status      ContentStatus @default(DRAFT)
  isActive    Boolean       @default(true)
  publishedAt DateTime?

  // ===== AI ìƒì„± ë©”íƒ€ë°ì´í„° =====
  aiModel         String?   // "claude-sonnet-4-20250514" ë“±
  aiGeneratedAt   DateTime? // AI ìƒì„± ì‹œê°
  aiPromptVersion String?   // ì‚¬ìš©ëœ í”„ë¡¬í”„íŠ¸ ë²„ì „
  humanReviewed   Boolean   @default(false)
  reviewedBy      String?   // ê²€í† ì ID
  reviewedAt      DateTime?
  reviewNotes     String?   // ê²€í†  ë…¸íŠ¸

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  examples    Example[]
  images      WordImage[]
  visuals     WordVisual[]   // 3-ì´ë¯¸ì§€ ì‹œê°í™” ì‹œìŠ¤í…œ
  videos      WordVideo[]
  rhymes      Rhyme[]
  mnemonics   Mnemonic[]
  etymology   Etymology?
  synonyms    Synonym[]
  antonyms    Antonym[]
  collocations Collocation[]
  progress    UserProgress[]
  examLevels  WordExamLevel[]  // ë‹¤ì¤‘ ì‹œí—˜/ë ˆë²¨ ë§¤í•‘
  productPackages ProductPackageWord[]  // ë‹¨í’ˆ ìƒí’ˆ ë§¤í•‘

  @@unique([word, examCategory])  // ê°™ì€ ë‹¨ì–´ë¥¼ ì—¬ëŸ¬ ì‹œí—˜ì— ì¶”ê°€ ê°€ëŠ¥
  @@index([word])
  @@index([difficulty])
  @@index([cefrLevel])
  @@index([examCategory])
  @@index([frequency])
  @@index([level])
  @@index([status])
}

// ë‹¨ì–´-ì‹œí—˜-ë ˆë²¨ ë§¤í•‘ í…Œì´ë¸” (ë‹¤ì¤‘ ì‹œí—˜ ì§€ì›)
// ì˜ˆ: "abandon"ì´ CSAT-L1, TEPS-L2ì— ë™ì‹œì— ì†í•  ìˆ˜ ìˆìŒ
model WordExamLevel {
  id           String        @id @default(uuid())
  wordId       String
  examCategory ExamCategory
  level        String?       // L1, L2, L3 (nullable for CSAT_BASIC, EBS)
  frequency    Int           @default(0)  // ì‹œí—˜ë³„ ë¹ˆë„
  status       ContentStatus @default(DRAFT)  // ì‹œí—˜ë³„ ë°œí–‰ ìƒíƒœ

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  word         Word          @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([wordId, examCategory])  // ë‹¨ì–´ë‹¹ ì‹œí—˜ì€ í•˜ë‚˜ì˜ ë ˆë²¨ë§Œ
  @@index([wordId])
  @@index([examCategory])
  @@index([level])
  @@index([status])
  @@index([examCategory, level])
  @@index([examCategory, status])
}

enum PartOfSpeech {
  NOUN
  VERB
  ADJECTIVE
  ADVERB
  PRONOUN
  PREPOSITION
  CONJUNCTION
  INTERJECTION
}

enum DifficultyLevel {
  BASIC
  INTERMEDIATE
  ADVANCED
}

// CEFR Level (ìœ ëŸ½ê³µí†µì°¸ì¡°ê¸°ì¤€)
enum CEFRLevel {
  A1   // Elementary
  A2   // Pre-intermediate
  B1   // Intermediate
  B2   // Upper-intermediate
  C1   // Advanced
  C2   // Proficiency
}

// Content Status for Admin workflow
enum ContentStatus {
  DRAFT           // ì´ˆì•ˆ - AI ìƒì„± ì§í›„
  PENDING_REVIEW  // ê²€í†  ëŒ€ê¸°
  APPROVED        // ìŠ¹ì¸ë¨ - ë°œí–‰ ê°€ëŠ¥
  PUBLISHED       // ë°œí–‰ë¨
  ARCHIVED        // ë³´ê´€ë¨
}

// Exam Categories for Korean users
enum ExamCategory {
  CSAT          // ìˆ˜ëŠ¥ (ëŒ€í•™ìˆ˜í•™ëŠ¥ë ¥ì‹œí—˜) - L1 ì´ˆê¸‰, L2 ì¤‘ê¸‰, L3 ê³ ê¸‰
  CSAT_2026     // 2026 ìˆ˜ëŠ¥ ê¸°ì¶œ - LISTENING, READING_2, READING_3
  CSAT_BASIC    // ìˆ˜ëŠ¥ ê¸°ì´ˆ (ì¤‘í•™ í•„ìˆ˜ ì–´íœ˜)
  CSAT_ARCHIVE  // ìˆ˜ëŠ¥ ì•„ì¹´ì´ë¸Œ (ë³´ê´€ìš©)
  EBS           // EBS ì—°ê³„ ì–´íœ˜
  TEPS          // í…ìŠ¤ (ì„œìš¸ëŒ€ ì˜ì–´ëŠ¥ë ¥ì‹œí—˜) - L1 ê¸°ë³¸, L2 í•„ìˆ˜
  TEPS_ARCHIVE  // í…ìŠ¤ ì•„ì¹´ì´ë¸Œ (ë³´ê´€ìš©)
  TOEIC         // í† ìµ (ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ì–´)
  TOEFL         // í† í”Œ (í•™ìˆ  ì˜ì–´)
  SAT           // SAT (ë¯¸êµ­ ëŒ€ì…)
}

// ë‹¨ì–´/êµ¬ë¬¸ íƒ€ì… (Word Pool êµ¬ë¶„ìš©)
enum WordType {
  WORD          // ë‹¨ì¼ ë‹¨ì–´: abandon, ubiquitous
  PHRASE        // êµ¬ë¬¸: a biting cold, break the news
  IDIOM         // ìˆ™ì–´: rain cats and dogs, be all thumbs
  PHRASAL_VERB  // êµ¬ë™ì‚¬: break into, carry on, give off
  COLLOCATION   // ì—°ì–´: make a decision, take a shower
}

// ============================================
// Learning Methods
// ============================================

// 1. Examples
model Example {
  id        String   @id @default(uuid())
  wordId    String
  sentence  String
  translation String? // í•œêµ­ì–´ ë²ˆì—­
  audioUrl  String?

  // ===== ì˜ˆë¬¸ ë¶„ë¥˜ (Content Pipeline) =====
  isFunny       Boolean  @default(false)  // ì¬ë¯¸ìˆëŠ” ì˜ˆë¬¸ ì—¬ë¶€
  isReal        Boolean  @default(true)   // ì‹¤ì œ ì‚¬ìš© ì˜ˆë¬¸ vs í•™ìŠµìš©
  source        String?  // ì¶œì²˜ (ì˜í™”, ë“œë¼ë§ˆ, ë‰´ìŠ¤ ë“±)
  highlightWord String?  // ê°•ì¡°í•  ë‹¨ì–´
  grammarNote   String?  // ë¬¸ë²• ì„¤ëª…
  order         Int      @default(0)  // ì •ë ¬ ìˆœì„œ

  createdAt DateTime @default(now())

  word      Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

// 2. Images
model WordImage {
  id          String   @id @default(uuid())
  wordId      String
  imageUrl    String
  thumbnailUrl String?
  description String?
  source      ImageSource @default(AI_GENERATED)
  aiPrompt    String?  // AI ìƒì„± ì´ë¯¸ì§€ì˜ í”„ë¡¬í”„íŠ¸

  createdAt   DateTime @default(now())

  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

enum ImageSource {
  AI_GENERATED
  STOCK_PHOTO
  ILLUSTRATION
  USER_UPLOADED
}

// ===== 3-ì´ë¯¸ì§€ ì‹œê°í™” ì‹œìŠ¤í…œ (VocaVision í•µì‹¬ ê¸°ëŠ¥) =====
// ê° ë‹¨ì–´ë§ˆë‹¤ 3ê°€ì§€ ì´ë¯¸ì§€ë¡œ ì‹œê°í™”
// - Concept (ì˜ë¯¸): ë‹¨ì–´ ì˜ë¯¸ë¥¼ ì§ê´€ì ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” ì´ë¯¸ì§€
// - Mnemonic (ì—°ìƒ): í•œêµ­ì–´ì‹ ì—°ìƒë²•ì— ë§ëŠ” ì´ë¯¸ì§€
// - Rhyme (ë¼ì´ë°): ë°œìŒ/ë¼ì´ë° ê¸°ë°˜ ìƒí™© ì´ë¯¸ì§€
model WordVisual {
  id          String      @id @default(uuid())
  wordId      String
  type        VisualType

  // ë¼ë²¨ (íƒ­ í‘œì‹œìš©)
  labelEn     String?     // "Concept", "Mnemonic", "Rhyme"
  labelKo     String?     // "ì˜ë¯¸", "ì—°ìƒ", "ë¼ì´ë°"

  // ìº¡ì…˜ (ì´ë¯¸ì§€ ì„¤ëª…)
  captionEn   String?     // ì˜ì–´ ìº¡ì…˜
  captionKo   String?     // í•œêµ­ì–´ ìº¡ì…˜ (í•™ìŠµììš©)

  // ì´ë¯¸ì§€ URL (ì •ì  ì´ë¯¸ì§€ ë˜ëŠ” GIF)
  imageUrl    String?     // Cloudinary URL (GIF ì§€ì›)

  // AI ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸
  promptEn    String?     @db.Text  // DALL-E/Midjourney í”„ë¡¬í”„íŠ¸

  // ì •ë ¬ ìˆœì„œ
  order       Int         @default(0)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  word        Word        @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([wordId, type])
  @@index([wordId])
}

enum VisualType {
  CONCEPT    // ì˜ë¯¸ ì‹œê°í™” (dormant â†’ íœ´í™”ì‚°)
  MNEMONIC   // ì—°ìƒë²• ì´ë¯¸ì§€ (dormant â†’ doormanì´ ì¡¸ê³  ìˆìŒ)
  RHYME      // ë¼ì´ë° ì´ë¯¸ì§€ (daunting to dormant man)
}

// 3. Videos/Animations
model WordVideo {
  id          String   @id @default(uuid())
  wordId      String
  videoUrl    String
  thumbnailUrl String?
  duration    Int?     // Duration in seconds
  type        VideoType @default(ANIMATION)
  description String?

  createdAt   DateTime @default(now())

  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

enum VideoType {
  ANIMATION
  LIVE_ACTION
  WHITEBOARD
  MOTION_GRAPHICS
}

// 4. Rhyming
model Rhyme {
  id          String   @id @default(uuid())
  wordId      String
  rhymingWord String
  similarity  Float    // 0.0 ~ 1.0 (ìœ ì‚¬ë„)
  example     String?  // ì˜ˆë¬¸ìœ¼ë¡œ í•¨ê»˜ ì‚¬ìš©

  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

// 5. Mnemonics (ì—°ìƒë²•)
model Mnemonic {
  id          String   @id @default(uuid())
  wordId      String
  title       String
  content     String
  koreanHint  String?  // í•œêµ­ì–´ ì—°ìƒ íŒíŠ¸ (ê²½ì„ ì‹ ìŠ¤íƒ€ì¼)
  imageUrl    String?  // ì—°ìƒ ì´ë¯¸ì§€ URL
  source      MnemonicSource @default(AI_GENERATED)
  rating      Float    @default(0)
  ratingCount Int      @default(0)

  // ===== WHISK ì´ë¯¸ì§€ ìƒì„± (Content Pipeline) =====
  whiskPrompt String?  // WHISK ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸
  whiskStyle  String?  // "animation", "illustration"
  gifUrl      String?  // WHISK ìƒì„± GIF URL

  createdAt   DateTime @default(now())

  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
  @@index([rating])
}

enum MnemonicSource {
  AI_GENERATED
  EXPERT_CREATED
  COMMUNITY
}

// User-created mnemonics
model CustomMnemonic {
  id        String   @id @default(uuid())
  userId    String
  wordId    String
  content   String
  isPrivate Boolean  @default(false)

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([wordId])
}

// 6. Etymology (ì–´ì›)
model Etymology {
  id          String   @id @default(uuid())
  wordId      String   @unique
  origin      String
  language    String?  // ì–´ì› ì–¸ì–´ (Latin, Greek, French, Germanic ë“±)
  rootWords   String[] // Array of root words
  evolution   String   // ë‹¨ì–´ì˜ ë°œì „ ê³¼ì •
  relatedWords String[] // ê°™ì€ ì–´ì›ì„ ê°€ì§„ ë‹¨ì–´ë“¤
  breakdown   String?  // ì–´ì› ë¶„í•´ ì„¤ëª…

  createdAt   DateTime @default(now())

  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)
}

// 7. Synonyms & Antonyms
model Synonym {
  id        String   @id @default(uuid())
  wordId    String
  synonym   String
  nuance    String?  // ë‰˜ì•™ìŠ¤ ì°¨ì´ ì„¤ëª…

  word      Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

model Antonym {
  id        String   @id @default(uuid())
  wordId    String
  antonym   String
  explanation String?

  word      Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

// 8. Collocations (ì½œë¡œì¼€ì´ì…˜)
model Collocation {
  id          String   @id @default(uuid())
  wordId      String
  phrase      String   // "make a decision"
  translation String?  // "ê²°ì •ì„ ë‚´ë¦¬ë‹¤"
  exampleEn   String?  // ì˜ˆë¬¸ (ì˜ì–´)
  exampleKo   String?  // ì˜ˆë¬¸ (í•œêµ­ì–´)
  type        String?  // "verb+noun", "adj+noun", "adv+adj"
  frequency   Int      @default(0)  // ì‚¬ìš© ë¹ˆë„
  order       Int      @default(0)

  createdAt   DateTime @default(now())

  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

// ============================================
// Learning Progress & Spaced Repetition
// ============================================

model UserProgress {
  id              String   @id @default(uuid())
  userId          String
  wordId          String
  examCategory    ExamCategory  // ì‹œí—˜ ì¹´í…Œê³ ë¦¬ (CSAT, TEPS ë“±)
  level           String        // ë ˆë²¨ (L1, L2, L3 ë“±)

  // Spaced Repetition (SM-2 Algorithm)
  easeFactor      Float    @default(2.5)
  interval        Int      @default(1)  // Days until next review
  repetitions     Int      @default(0)
  nextReviewDate  DateTime
  lastReviewDate  DateTime?

  // Progress
  masteryLevel    MasteryLevel @default(NEW)
  correctCount    Int      @default(0)
  incorrectCount  Int      @default(0)
  totalReviews    Int      @default(0)

  // ë³µìŠµ ëŒ€ìƒ ì—¬ë¶€ (ëª¨ë¦„/ì• ë§¤í•¨ í´ë¦­ ì‹œ true)
  needsReview     Boolean  @default(false)
  // ë³µìŠµ í€´ì¦ˆ ì •ë‹µ íšŸìˆ˜ (ë³µìŠµ ëŒ€ìƒ ë‹¨ì–´ ì¤‘ í€´ì¦ˆ ì •ë‹µ íšŸìˆ˜)
  reviewCorrectCount Int   @default(0)

  // ë³µìŠµ ë¡œì§ìš© í•„ë“œ (2ì¼í¬í•¨/1ì¼ì‰¼ + D+3 ì•Œì•˜ìŒ)
  initialRating   Int      @default(1)   // ì²« í•™ìŠµ ì‹œ rating (1=ëª¨ë¦„, 5=ì•Œì•˜ìŒ)
  learnedAt       DateTime @default(now()) // ì²« í•™ìŠµ ë‚ ì§œ

  // Learning methods used
  usedImages      Boolean  @default(false)
  usedVideos      Boolean  @default(false)
  usedRhymes      Boolean  @default(false)
  usedMnemonics   Boolean  @default(false)
  usedEtymology   Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  word            Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId, examCategory, level])
  @@index([userId])
  @@index([nextReviewDate])
  @@index([needsReview])
  @@index([examCategory, level])
  // ğŸš€ /review í˜ì´ì§€ ìµœì í™”ìš© ë³µí•© ì¸ë±ìŠ¤
  @@index([userId, examCategory, level, correctCount])        // getDueReviews ë©”ì¸ ì¿¼ë¦¬
  @@index([userId, examCategory, level, lastReviewDate])      // ë§ˆì§€ë§‰ ë³µìŠµ ë‚ ì§œ ì¡°íšŒ
  @@index([userId, correctCount, nextReviewDate])             // ë‚´ì¼/ì´ë²ˆì£¼ ì˜ˆì • ì¹´ìš´íŠ¸
}

enum MasteryLevel {
  NEW
  LEARNING
  FAMILIAR
  MASTERED
}

// ============================================
// Study Sessions & Reviews
// ============================================

model StudySession {
  id            String   @id @default(uuid())
  userId        String
  startTime     DateTime @default(now())
  endTime       DateTime?
  duration      Int?     // Duration in seconds
  wordsStudied  Int      @default(0)
  wordsCorrect  Int      @default(0)

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviews       Review[]

  @@index([userId])
  @@index([startTime])
}

model Review {
  id              String   @id @default(uuid())
  userId          String
  wordId          String
  sessionId       String?

  rating          Int      // 1-5 (1: Again, 2: Hard, 3: Good, 4: Easy, 5: Perfect)
  responseTime    Int?     // Response time in milliseconds
  learningMethod  LearningMethod

  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  session         StudySession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([sessionId])
}

enum LearningMethod {
  FLASHCARD
  IMAGE
  VIDEO
  RHYME
  MNEMONIC
  ETYMOLOGY
  QUIZ
  WRITING
  INTERACTIVE_DOC  // n8n-style interactive documentation
}

// ============================================
// Gamification & Achievements
// ============================================

model Achievement {
  id          String   @id @default(uuid())
  name        String
  description String
  icon        String
  requirement Int      // Required value to unlock
  type        AchievementType

  users       UserAchievement[]
}

enum AchievementType {
  WORDS_LEARNED
  DAILY_STREAK
  PERFECT_REVIEWS
  METHODS_USED
  STUDY_TIME
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
}

// ============================================
// Content Collections
// ============================================

model Collection {
  id          String   @id @default(uuid())
  name        String
  slug        String?  @unique // URL-friendly identifier (e.g., "csat-starter-100")
  description String?
  icon        String?
  category    String
  difficulty  DifficultyLevel
  isPublic    Boolean  @default(true)

  wordIds     String[] // Array of word IDs

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([difficulty])
  @@index([slug])
}

// ============================================
// Custom Decks (Anki-style)
// ============================================

model Deck {
  id          String   @id @default(uuid())
  name        String
  description String?
  userId      String
  isPublic    Boolean  @default(false)
  tags        String[] // Array of tags
  wordIds     String[] // Array of word IDs

  // Cloning info
  clonedFromId String?
  cloneCount   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isPublic])
}

// ============================================
// Bookmarks & Favorites
// ============================================

model Bookmark {
  id        String   @id @default(uuid())
  userId    String
  wordId    String
  notes     String?  // Personal notes
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId])
  @@index([userId])
  @@index([wordId])
}

// ============================================
// Notifications
// ============================================

model Notification {
  id          String   @id @default(uuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  data        String?  // JSON data for additional context
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([isRead])
}

enum NotificationType {
  REVIEW_REMINDER    // Time to review words
  STREAK_WARNING     // About to lose streak
  STREAK_ACHIEVED    // Reached a streak milestone
  ACHIEVEMENT_UNLOCK // New achievement unlocked
  GOAL_COMPLETED     // Daily goal completed
  GOAL_REMINDER      // Reminder to complete daily goal
  WEEKLY_SUMMARY     // Weekly progress summary
  NEW_WORDS          // New words available
}

// ============================================
// Interactive Documentation Progress
// ============================================

model InteractiveDocProgress {
  id              String   @id @default(uuid())
  userId          String
  wordId          String
  stepId          String   // Step identifier (step-introduction, step-visualization, etc.)
  stepNumber      Int      // 1-5

  // Progress tracking
  started         Boolean  @default(false)
  completed       Boolean  @default(false)
  timeSpent       Int      @default(0)  // Total time spent in seconds
  interactions    Int      @default(0)  // Number of user interactions
  score           Float?   // Quiz/exercise score (0-100)

  // Timestamps
  startedAt       DateTime?
  completedAt     DateTime?
  lastInteraction DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, wordId, stepId])
  @@index([userId])
  @@index([wordId])
  @@index([userId, wordId])
  @@index([completed])
}

// Word completion tracking for interactive docs
model InteractiveDocCompletion {
  id              String   @id @default(uuid())
  userId          String
  wordId          String

  // Completion stats
  stepsCompleted  Int      @default(0)  // Number of steps completed (0-5)
  totalSteps      Int      @default(5)  // Total number of steps
  totalTimeSpent  Int      @default(0)  // Total time spent in seconds
  averageScore    Float?   // Average quiz/exercise score
  completionRate  Float    @default(0)  // Percentage (0-100)

  // Status
  isCompleted     Boolean  @default(false)
  completedAt     DateTime?
  lastAccessedAt  DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, wordId])
  @@index([userId])
  @@index([wordId])
  @@index([isCompleted])
}

// ============================================
// League System (Duolingo-style)
// ============================================

enum LeagueTier {
  BRONZE
  SILVER
  GOLD
  SAPPHIRE
  RUBY
  EMERALD
  AMETHYST
  PEARL
  OBSIDIAN
  DIAMOND
}

model League {
  id            String      @id @default(uuid())
  tier          LeagueTier
  weekStart     DateTime    // Monday of the week
  weekEnd       DateTime    // Sunday of the week

  // Zone settings
  promotionZone Int         @default(10)  // Top N get promoted
  demotionZone  Int         @default(5)   // Bottom N get demoted

  createdAt     DateTime    @default(now())

  memberships   LeagueMembership[]

  @@unique([tier, weekStart])
  @@index([tier])
  @@index([weekStart])
}

model LeagueMembership {
  id          String      @id @default(uuid())
  userId      String
  leagueId    String

  // XP earned this week
  weeklyXP    Int         @default(0)

  // Final rank at end of week (null until week ends)
  finalRank   Int?

  // Result (after week ends)
  result      LeagueResult?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  league      League      @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([userId, leagueId])
  @@index([userId])
  @@index([leagueId])
  @@index([weeklyXP])
}

enum LeagueResult {
  PROMOTED
  STAYED
  DEMOTED
}

// ============================================
// Learning Records (í€´ì¦ˆ/í•™ìŠµ ê¸°ë¡)
// ============================================

model LearningRecord {
  id              String   @id @default(uuid())
  userId          String
  wordId          String

  // í€´ì¦ˆ íƒ€ì…
  quizType        QuizType

  // ê²°ê³¼
  isCorrect       Boolean
  selectedAnswer  String?   // ì„ íƒí•œ ë‹µ
  correctAnswer   String?   // ì •ë‹µ

  // ì‹œê°„
  responseTime    Int?      // ì‘ë‹µ ì‹œê°„ (ms)

  // ì„¸ì…˜ ì •ë³´
  sessionId       String?   // ì„¸ì…˜ ê·¸ë£¹í™”ìš©

  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@index([userId, quizType])
  @@index([sessionId])
}

enum QuizType {
  LEVEL_TEST      // ë ˆë²¨ í…ŒìŠ¤íŠ¸
  ENG_TO_KOR      // ì˜â†’í•œ í€´ì¦ˆ
  KOR_TO_ENG      // í•œâ†’ì˜ í€´ì¦ˆ
  FLASHCARD       // í”Œë˜ì‹œì¹´ë“œ
  SPELLING        // ìŠ¤í ë§
}

// ============================================
// Content Pipeline - AI ìƒì„± ì‘ì—… ê´€ë¦¬
// ============================================

// AI ìƒì„± ì‘ì—… í (ë°°ì¹˜ ì²˜ë¦¬ìš©)
model ContentGenerationJob {
  id            String      @id @default(uuid())

  // ì‘ì—… ëŒ€ìƒ
  wordId        String?     // ë‹¨ì¼ ë‹¨ì–´ ID
  batchId       String?     // ë°°ì¹˜ ì‘ì—… ê·¸ë£¹ ID
  inputWords    String[]    // ë°°ì¹˜ ì²˜ë¦¬í•  ë‹¨ì–´ë“¤

  // ì‘ì—… ìƒíƒœ
  status        String      @default("pending")  // pending, processing, completed, failed
  progress      Int         @default(0)          // 0-100 ì§„í–‰ë¥ 

  // ìƒì„± ì„¤ì •
  generateFields String[]   // ["etymology", "mnemonic", "examples"] ìƒì„±í•  í•„ë“œ
  examCategory  ExamCategory?
  cefrLevel     CEFRLevel?
  aiModel       String      @default("claude-sonnet-4-20250514")

  // ê²°ê³¼
  result        Json?       // ìƒì„±ëœ ì½˜í…ì¸  JSON
  errorMessage  String?
  retryCount    Int         @default(0)

  // ìš”ì²­ì
  requestedById String?

  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime    @default(now())

  @@index([status])
  @@index([batchId])
  @@index([createdAt])
}

// ì½˜í…ì¸  ë³€ê²½ ì´ë ¥ (Audit Log)
model ContentAuditLog {
  id            String      @id @default(uuid())

  entityType    String      // "Word", "Example", "Mnemonic"
  entityId      String
  action        String      // "create", "update", "delete", "publish", "review"

  previousData  Json?       // ë³€ê²½ ì „ ë°ì´í„°
  newData       Json?       // ë³€ê²½ í›„ ë°ì´í„°
  changedFields String[]    // ë³€ê²½ëœ í•„ë“œëª…ë“¤

  performedById String?     // ìˆ˜í–‰ì ID
  performedAt   DateTime    @default(now())
  ipAddress     String?
  userAgent     String?

  @@index([entityType, entityId])
  @@index([performedAt])
  @@index([performedById])
}

// ============================================
// Payments (í† ìŠ¤í˜ì´ë¨¼ì¸ )
// ============================================

model Payment {
  id            String        @id @default(uuid())
  userId        String

  // ì£¼ë¬¸ ì •ë³´
  orderId       String        @unique  // ê³ ìœ  ì£¼ë¬¸ ID
  orderName     String                 // ì£¼ë¬¸ëª… (ì˜ˆ: "VocaVision ë² ì´ì§ ì›”ê°„ êµ¬ë…")

  // ê¸ˆì•¡
  amount        Int                    // ê²°ì œ ê¸ˆì•¡ (ì›)

  // í† ìŠ¤í˜ì´ë¨¼ì¸  ì •ë³´
  paymentKey    String?       @unique  // í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œí‚¤
  method        String?                // ê²°ì œ ìˆ˜ë‹¨ (ì¹´ë“œ, ê°„í¸ê²°ì œ ë“±)

  // ìƒíƒœ
  status        PaymentStatus @default(PENDING)

  // í”Œëœ ì •ë³´
  plan          String                 // 'basic', 'premium'
  billingCycle  String                 // 'monthly', 'yearly'

  // ë¹Œë§í‚¤ (ì •ê¸°ê²°ì œìš©)
  billingKey    String?                // ì•”í˜¸í™”ëœ ë¹Œë§í‚¤
  customerKey   String?                // ê³ ê° ì‹ë³„í‚¤

  // ì—ëŸ¬ ì •ë³´
  failReason    String?

  // íƒ€ì„ìŠ¤íƒ¬í”„
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  purchase      UserPurchase?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum PaymentStatus {
  PENDING       // ê²°ì œ ëŒ€ê¸°
  COMPLETED     // ê²°ì œ ì™„ë£Œ
  FAILED        // ê²°ì œ ì‹¤íŒ¨
  CANCELLED     // ê²°ì œ ì·¨ì†Œ
  REFUNDED      // í™˜ë¶ˆë¨
}

// ============================================
// Product Packages (ë‹¨í’ˆ ìƒí’ˆ)
// ============================================

model ProductPackage {
  id            String    @id @default(uuid())

  // ìƒí’ˆ ì •ë³´
  name          String                 // "TEPS ìµœë‹¤ ë¹ˆì¶œ 100"
  slug          String    @unique      // "teps-top-100" (URLìš©)
  description   String?                // ìƒí’ˆ ì„¤ëª…
  shortDesc     String?                // ì¹´ë“œì— í‘œì‹œí•  ì§§ì€ ì„¤ëª…

  // ê°€ê²©
  price         Int                    // ê°€ê²© (ì›)
  originalPrice Int?                   // ì •ê°€ (í• ì¸ ì „, í• ì¸ í‘œì‹œìš©)

  // ì´ìš© ê¸°ê°„
  durationDays  Int                    // ì´ìš© ê¸°ê°„ (ì¼) - ì˜ˆ: 365

  // í‘œì‹œ ì •ë³´
  badge         String?                // "BEST", "NEW", "EVENT"
  badgeColor    String?                // ë°°ì§€ ìƒ‰ìƒ
  imageUrl      String?                // ìƒí’ˆ ì´ë¯¸ì§€
  displayOrder  Int       @default(0)  // í‘œì‹œ ìˆœì„œ

  // ìƒíƒœ
  isActive      Boolean   @default(true)
  isComingSoon  Boolean   @default(false)

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  words         ProductPackageWord[]
  purchases     UserPurchase[]

  @@index([isActive])
  @@index([displayOrder])
}

model ProductPackageWord {
  id          String    @id @default(uuid())
  packageId   String
  wordId      String
  displayOrder Int      @default(0)  // ë‹¨ì–´ í‘œì‹œ ìˆœì„œ

  createdAt   DateTime  @default(now())

  // Relations
  package     ProductPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  word        Word           @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([packageId, wordId])
  @@index([packageId])
  @@index([wordId])
}

model UserPurchase {
  id            String    @id @default(uuid())
  visibleId     String    @unique @default(cuid())  // ì‚¬ìš©ìì—ê²Œ í‘œì‹œë˜ëŠ” ì£¼ë¬¸ë²ˆí˜¸

  userId        String
  packageId     String

  // ê²°ì œ ì •ë³´
  paymentId     String?   @unique  // Payment í…Œì´ë¸” ì—°ê²°
  amount        Int                 // ê²°ì œ ê¸ˆì•¡

  // ì´ìš© ê¸°ê°„
  purchasedAt   DateTime  @default(now())
  expiresAt     DateTime            // ë§Œë£Œì¼

  // ìƒíƒœ
  status        PurchaseStatus @default(ACTIVE)

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  package       ProductPackage @relation(fields: [packageId], references: [id])
  payment       Payment?       @relation(fields: [paymentId], references: [id])

  @@index([userId])
  @@index([packageId])
  @@index([expiresAt])
  @@index([status])
}

enum PurchaseStatus {
  ACTIVE        // ì´ìš© ì¤‘
  EXPIRED       // ë§Œë£Œë¨
  REFUNDED      // í™˜ë¶ˆë¨
}

// ============================================
// Learning Session (í•™ìŠµ ì„¸ì…˜ ê´€ë¦¬)
// ============================================

// ì „ì²´ ë ˆë²¨ í•™ìŠµ ì„¸ì…˜ - ë‹¨ì–´ ìˆœì„œ ê³ ì •, ìƒˆë¡œê³ ì¹¨í•´ë„ ìœ ì§€
model LearningSession {
  id            String    @id @default(cuid())
  userId        String
  examCategory  String    // CSAT, TEPS ë“±
  level         String    // L1, L2, L3

  // ì…”í”Œëœ ë‹¨ì–´ ìˆœì„œ (JSON ë°°ì—´: wordId ëª©ë¡)
  wordOrder     String    @db.Text  // JSON stringified array

  // ì§„í–‰ ìƒíƒœ
  totalWords    Int       // ì „ì²´ ë‹¨ì–´ ìˆ˜ (ì˜ˆ: 760)
  currentSet    Int       @default(0)   // í˜„ì¬ ì„¸íŠ¸ (0-based, ì˜ˆ: 0-37)
  currentIndex  Int       @default(0)   // ì„¸íŠ¸ ë‚´ í˜„ì¬ ë‹¨ì–´ ì¸ë±ìŠ¤ (0-19)

  // ì„¸ì…˜ ìƒíƒœ
  status        LearningSessionStatus @default(IN_PROGRESS)

  // í†µê³„
  completedSets Int       @default(0)   // ì™„ë£Œëœ ì„¸íŠ¸ ìˆ˜
  totalReviewed Int       @default(0)   // ì´ í•™ìŠµí•œ ë‹¨ì–´ ìˆ˜

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, examCategory, level, status])  // ì‚¬ìš©ìë‹¹ ì§„í–‰ì¤‘ì¸ ì„¸ì…˜ì€ 1ê°œë§Œ
  @@index([userId])
  @@index([examCategory, level])
  @@index([status])
}

enum LearningSessionStatus {
  IN_PROGRESS   // ì§„í–‰ ì¤‘
  COMPLETED     // ì™„ë£Œ
  ABANDONED     // í¬ê¸°/ì¬ì‹œì‘ìœ¼ë¡œ ì¢…ë£Œ
}
